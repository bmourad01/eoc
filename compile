#!/bin/sh

# exit on error
set -e

INPROG=$1
DIR="./output/"
PROG="$(basename ${INPROG})"
PROGNAME="${PROG%.*}"
ASMFILE="${DIR}${PROGNAME}.S"
OBJFILE="${DIR}${PROGNAME}.o"
RUNTIMEOBJ="${DIR}runtime.o"
CC="cc"
CFLAGS="-std=c99 -Wall -Wextra -g"

# setup output directory
mkdir -p $DIR

# compile and assemble the program
dune exec bin/print_x86.exe $1 > $ASMFILE
nasm -g -f elf64 -o $OBJFILE $ASMFILE

# compile the C runtime
$CC $CFLAGS -c runtime/runtime.c -o $RUNTIMEOBJ

# link into an executable
$CC $CFLAGS -o "${DIR}$PROGNAME" $OBJFILE $RUNTIMEOBJ
